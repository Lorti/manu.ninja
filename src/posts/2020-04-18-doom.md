---
layout: layouts/post.njk
permalink: /porting-doom-to-webassembly-using-emscripten/
title: Porting Doom to WebAssembly using Emscripten
description: How to fail miserably as a web developer when confronted with C and Makefiles and hack yourself to a working WebAssembly application
date: 2020-04-18
categories: [coding, games]
tags: [js, webgl]
thumbnail: /author.jpg
---

In times of a world pandemic there's one form of escapism that soothes me the most: computer games.

![Doom (1993) in Google Chrome 80](/images/doom.png)

<https://emscripten.org/>

## Which Doom source code port should I use?
<https://en.wikipedia.org/wiki/List_of_Doom_source_ports>
<https://doomwiki.org/wiki/Category:Doom_ports>

Chocolate Doom and GZDoom are in active development, which is why I focused on them first. All modern ports run cross-platform, support all games built with the Doom engine and add modern graphical features. Chocolate Doom aims to preserve the look, feel, and bugs of the originals. However, the majority of ports also add gameplay enhancements, like the ability to look up/down or jumping, and support customization/modding.

## Where do I get `doom.wad`?
Piracy

## Compile Chocolate Doom
`Segmentation Fault`

## Compile GZDoom
<https://github.com/coelckers/gzdoom>
<https://zdoom.org/wiki/Compile_GZDoom_on_Mac_OS_X>

Homebrew

### Problem #1 How the hell does `make` work???
```bash
./configure
make
```

> CMake is a cross-platform build system generator.
> The cmake executable is the command-line interface of the cross-platform buildsystem generator CMake.

```bash
mkdir build
cd build
cmake ..
cmake --build .
```

Modern build chains feature a ton of files, which are outlined in [this flow chart](https://en.wikipedia.org/wiki/Autoconf). https://en.wikipedia.org/wiki/GNU_Autotools?

I then discovered, that there is a GUI for `cmake`, which is called `ccmake` (there is no `cmake-gui` on my machine, which I tried first). Apparently all my problems can be solved by adding more and more C's in front.

> After you click Configure, you will end up having to tell CMake where the sound libraries are located, so some options must be changed (you may need to switch to advanced view to see these options). First, disable DYN_OPENAL and click Configure again, then change the OPENAL_INCLUDE_DIR entry to /usr/local/opt/openal-soft/include/AL and the OPENAL_LIBRARY one to /usr/local/opt/openal-soft/lib/libopenal.dylib.

You have to configure, then you will be greeted with more variables to configure. If you use configure often enough, you will be able to press G for generate.

Then I can finally run make to build the game for my platform.

`cmake ..` throws a `Could NOT find ZMusic (missing: ZMUSIC_LIBRARIES ZMUSIC_INCLUDE_DIR)` error.

### Problem #2 ZMusic
<https://forum.zdoom.org/viewtopic.php?f=49&t=67489>
<https://github.com/coelckers/ZMusic>

I was able to build ZMusic on the first try<!--, but I failed to pass the variable to `cmake`. I then discovered, that there is a GUI for `cmake`, which is called `ccmake`. Apparently all my problems can be solved by adding more and more C's in front.-->

```bash
mkdir build
cd build
ccmake ..
# [t] Toggle advanced mode (currently off)
# ZMUSIC_INCLUDE_DIR /Users/manuelwieser/Documents/temp/doom-emscripten/zmusic/build_install/include
# ZMUSIC_LIBRARIES /Users/manuelwieser/Documents/temp/doom-emscripten/zmusic/build_install/lib/libzmusic.dylib
# [c] Configure
# [g] Generate
cmake --build .
```


On my MacBook Air (13-inch, Mid 2013) GZDoom took ages to compile.

I was then able to run Doom via `./gzdoom.app/Contents/MacOS/gzdoom` (yes, I could have clicked the .app in the Finder).

## Emscripten
<https://emscripten.org/>
<https://webassembly.org/>
`emcc -v`
<https://emscripten.org/docs/compiling/Building-Projects.html#building-projects>
`emcmake cmake ..`
`emmake make`

## What the hell is this thing building? It’s not simple C code anymore ...

## Compiling Chocolate Doom to WebAssembly
```
export PKG_CONFIG_PATH=/Users/manuelwieser/Documents/temp/doom-emscripten/chocpkg/install/lib/pkgconfig
emconfigure ./configure
```

## Someone already compiled Chocolate Doom to WebAssembly
<https://github.com/lazarv/wasm-doom>
<https://wadcmd.com/>

## All of this fluff is nested and complicated ...
<https://github.com/dejanmilivojevic/sdldoom.js>
<https://github.com/UstymUkhman/webDOOM>

## Compiling SDLDoom to WebAssembly
<https://www.libsdl.org/projects/doom/>

SDLDoom is a minimalistic port of Doom by Sam Lantinga from 1997. It uses the Simple DirectMedia Layer library for audio/video and input. Apart from making it run on all platform supported by SDL Lantinga didn't make a lot of changes to the [source code released by id Software](https://github.com/id-Software/DOOM). It is "just" a folder with C code and a `configure` then `make` build process.

Who is Sam Lantinga? Sam Lantinga created the SDL library. He got the idea while porting a Windows application to Macintosh. He then used SDL to port Doom to BeOS. Lantinga worked for Blizzard from 2001-2011 and joined Valve in 2012, which explains why many of their games use the SDL (2) library.

```bash
emconfigure ./configure
emmake make
mv doom doom.bc # Thank you, Dejan!
emcc doom.bc -o index.html
```

### Fixing compilation errors

#### You should hack this file for your BSD sockets layer

`i_net.c` throws an error in line 54.

```c
#error You should hack this file for your BSD sockets layer
```

I followed the error message's advice and copied parts of the preprocessor directives for other platforms until `i_net.c` compiled.

```c
#ifdef __EMSCRIPTEN__
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <unistd.h>
#include <netdb.h>
#include <sys/ioctl.h>
#ifndef IPPORT_USERRESERVED
#define IPPORT_USERRESERVED	5000
#endif
#endif
```

#### `SDL_byteorder.h` file not found

`i_sound.c`

```d
+ #ifdef __EMSCRIPTEN__
+ #include "SDL_endian.h"
+ #else
#include "SDL_byteorder.h"
+ #endif
```

#### implicitly declaring library function `alloca`

`r_data.c`

```c
#ifdef __EMSCRIPTEN__
#include <alloca.h>
#endif
```

### Fixing runtime errors

#### Memory allocation exception in the browser

```
Assertion failed: failure to dynamicAlloc - memory growth etc. is not supported there, call malloc/sbrk directly
```

```diff
emconfigure ./configure
emmake make
mv doom doom.bc
- emcc doom.bc -o index.html
+ emcc doom.bc -o index.html -s ALLOW_MEMORY_GROWTH=1
```

#### The game immediately quits

```
Game mode indeterminate.
SDL_Quit called (and ignored)
```

```diff
emconfigure ./configure
emmake make
mv doom doom.bc
- doom.bc -o index.html -s ALLOW_MEMORY_GROWTH=1
+ doom.bc -o index.html --preload-file doom.wad -s ALLOW_MEMORY_GROWTH=1
```

#### SDL exception in the browser

```
Uncaught CopyOnLock is not supported for SDL_LockSurface with SDL_HWPALETTE flag setError
```

```js
SDL.defaults.copyOnLock = false;
```

<https://emscripten.org/docs/porting/connecting_cpp_and_javascript/Interacting-with-code.html#interacting-with-code-call-javascript-from-native>

```c
#ifdef TEST_SDL_LOCK_OPTS
  EM_ASM("SDL.defaults.copyOnLock = false; SDL.defaults.discardOnLock = true; SDL.defaults.opaqueFrontBuffer = false;");
#endif
```

#### The game shows a black screen, then halts at the closing credits

<https://emscripten.org/docs/porting/emscripten-runtime-environment.html#browser-main-loop>

`d_main.c`

```c/17
void D_DoomLoop (void)
{
    if (demorecording)
	G_BeginRecording ();

    if (M_CheckParm ("-debugfile"))
    {
	char    filename[20];
	sprintf (filename,"debug%i.txt",consoleplayer);
	printf ("debug output to: %s\n",filename);
	debugfile = fopen (filename,"w");
    }

    I_InitGraphics ();

    while (1)
    {
	updateFrame ();
    }
    #endif
}
```

```c
void updateFrame (void)
{
	// frame syncronous IO operations
	I_StartFrame ();

	// process one or more tics
	if (singletics)
	{
	    I_StartTic ();
	    D_ProcessEvents ();
	    G_BuildTiccmd (&netcmds[consoleplayer][maketic%BACKUPTICS]);
	    if (advancedemo)
		D_DoAdvanceDemo ();
	    M_Ticker ();
	    G_Ticker ();
	    gametic++;
	    maketic++;
	}
	else
	{
	    TryRunTics (); // will run at least one tic
	}

	S_UpdateSounds (players[consoleplayer].mo);// move positional sounds

	// Update display, next frame, with current state.
	D_Display ();
}
```

```diff
+ #ifdef __EMSCRIPTEN__
+ emscripten_set_main_loop (updateFrame, 0, true);
+ #else
while (1)
{
updateFrame ();
}
+ #endif
```

#### Incorrect WebAssembly MIME type

```
wasm streaming compile failed: TypeError: Failed to execute 'compile' on 'WebAssembly': Incorrect response MIME type. Expected 'application/wasm'.
falling back to ArrayBuffer instantiation
```

There are a lot of guides on how to add the MIME type to your Apache or nginx server config.

### Finished port

<https://github.com/Lorti/sdldoom.wasm>

![Doom (1993) in Google Chrome 80](/images/doom.png)

## Let’s have a look at the engine …
<http://fabiensanglard.net/doomIphone/doomClassicRenderer.php>
<http://fabiensanglard.net/gebbdoom/index.html>
